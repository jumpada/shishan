<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>社区资讯</title>
    <meta name="viewport" content="width=device-width, initial-scale=1,maximum-scale=1,user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <link rel="stylesheet" href="/static/plugin/mui/css/mui.min.css">
    <script src="/static/plugin/mui/js/mui.min.js"></script>
    <script src="/static/js/vue.min.js"></script>
    <style type="text/css">
        .mui-media {
            font-size: 14px;
        }

        .mui-table-view .mui-media-object {
            max-width: initial;
            width: 90px;
            height: 70px;
        }

        .meta-info {
            position: absolute;
            left: 115px;
            right: 15px;
            bottom: 8px;
            color: #8f8f94;
        }

        .meta-info .author,
        .meta-info .time {
            display: inline-block;
            font-size: 12px;
        }

        .meta-info .time {
            float: right;
        }

        .mui-table-view:before,
        .mui-table-view:after {
            height: 0;
        }

        .mui-content > .mui-table-view:first-child {
            margin-top: 1px;
        }
    </style>
</head>
<body>
<div class="mui-content" id="news">
    <!--列表信息流 开始-->
    <div id="list" class="mui-scroll-wrapper">
        <div class="mui-scroll">
            <ul class="mui-table-view">
                <li class="mui-table-view-cell mui-media" v-for="item in items">
                    <a href="javascript:;" :data-guid="item.id" @tap="open_detail(item)">
                        <img class="mui-media-object mui-pull-left" :src="item.cover">
                        <div class="mui-media-body">
                            <div class="mui-ellipsis-2">{{item.title}}</div>
                        </div>
                        <div class="meta-info">
                            <div class="author">{{item.author}}</div>
                            <div class="time">{{item.time}}</div>
                        </div>
                    </a>
                </li>
            </ul>
        </div>
    </div>
    <!--列表信息流 结束-->
</div>
<script type="text/javascript">
    var page = 1;

    //mui初始化，配置下拉刷新
    mui.init({
        pullRefresh: {
            container: '#list',
            down: {
                style: 'circle',
                offset: '0px',
                auto: true,
                callback: pulldownRefresh
            },
            up: {
                contentrefresh: '正在加载...',
                callback: pullupRefresh
            }
        }
    });

    /**
     *  下拉刷新获取最新列表
     */
    function pulldownRefresh() {
        var data = {
            page: 1,
            limit: 10
        };

        //请求最新列表信息流
        mui.getJSON("/info/data", data, function (rsp) {
            console.log(rsp);
            mui('#list').pullRefresh().endPulldownToRefresh();
            if (rsp && rsp.length > 0) {
                news.items = convert(rsp);
            }
        });
    }

    /**
     * 上拉加载拉取历史列表
     */
    function pullupRefresh() {
        var data = {
            page: page + 1,
            limit: 10
        };
        //请求历史列表信息流
        mui.getJSON("/info/data", data, function (rsp) {
            mui('#list').pullRefresh().endPullupToRefresh();
            if (rsp && rsp.length > 0) {
                page++;
                news.items = news.items.concat(convert(rsp));
            }
        });
    }

    //调整详细页
    function open_detail(item) {
        window.location = '/info/detail?id=' + item.id;
    }

    var news = new Vue({
        el: '#news',
        data: {
            items: [] //列表信息流数据
        }
    });

    /**
     * 1、将服务端返回数据，转换成前端需要的格式
     * 2、若服务端返回格式和前端所需格式相同，则不需要改功能
     *
     * @param {Array} items
     */
    function convert(items) {
        var newItems = [];
        items.forEach(function (item) {
            newItems.push({
                id: item.id,
                title: item.title,
                author: '狮山社区',
                cover: item.cover,
                time: dateUtils.format(item.releaseTime)
            });
        });
        return newItems;
    }

    /**
     * 格式化时间的辅助类，将一个时间转换成x小时前、y天前等
     */
    var dateUtils = {
        UNITS: {
            '年': 31557600000,
            '月': 2629800000,
            '天': 86400000,
            '小时': 3600000,
            '分钟': 60000,
            '秒': 1000
        },
        humanize: function (milliseconds) {
            var humanize = '';
            mui.each(this.UNITS, function (unit, value) {
                if (milliseconds >= value) {
                    humanize = Math.floor(milliseconds / value) + unit + '前';
                    return false;
                }
                return true;
            });
            return humanize || '刚刚';
        },
        format: function (dateStr) {
            var date = this.parse(dateStr)
            var diff = Date.now() - date.getTime();
            if (diff < this.UNITS['天']) {
                return this.humanize(diff);
            }

            var _format = function (number) {
                return (number < 10 ? ('0' + number) : number);
            };
            return date.getFullYear() + '-' + _format(date.getMonth() + 1) + '-' + _format(date.getDay()) + ' ' + _format(date.getHours()) + ':' + _format(date.getMinutes());
        },
        parse: function (str) { //将"yyyy-mm-dd HH:MM:ss"格式的字符串，转化为一个Date对象
            var a = str.split(/[^0-9]/);
            return new Date(a[0], a[1] - 1, a[2], a[3], a[4], a[5]);
        }
    };
</script>
</body>
</html>